<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Attendance System</title>
     <link
      rel="icon"
      href=""
      type="image/jpeg"
    />
    <link rel="apple-touch-icon" href="https://i.postimg.cc/bYVyX70v/check-in.png" />

    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        khmer: ['Battambang', 'cursive'],
                        moul: ['Moul', 'cursive'],
                    },
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Moul&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Battambang', sans-serif;
            background-color: #f1f5f9;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.90);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }

        /* --- PROFESSIONAL PRINT STYLES (A4 FIXED) --- */
        @media print {
            @page { 
                margin: 15mm 10mm; 
                size: A4 portrait; 
            }
            body { 
                background: white; 
                color: black; 
                print-color-adjust: exact; 
                -webkit-print-color-adjust: exact; 
                font-family: 'Battambang', sans-serif;
                font-size: 11pt;
            }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            /* Reset Widths */
            .max-w-md {
                max-width: none !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* Header Layout */
            .print-header {
                width: 100%;
                margin-bottom: 25px;
                text-align: center;
            }
            .national-motto {
                text-align: center;
                font-family: 'Moul', cursive;
                line-height: 1.6;
                margin-bottom: 20px;
            }
            .national-motto h3 { font-size: 12pt; font-weight: normal; margin: 0; }
            .national-motto h2 { font-size: 14pt; font-weight: normal; margin: 0; }

            .report-title {
                font-family: 'Moul', cursive;
                font-size: 16pt;
                color: #1e3a8a;
                text-decoration: underline;
                text-underline-offset: 6px;
                margin: 15px 0;
                font-weight: normal;
            }
            
            .doc-info {
                display: flex;
                justify-content: space-between;
                font-size: 10pt;
                margin-bottom: 20px;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
            }

            /* Summary Cards (Print) */
            .print-summary-grid {
                display: flex;
                justify-content: space-between;
                gap: 15px;
                margin-bottom: 25px;
            }
            .print-card {
                flex: 1;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 12px 5px;
                text-align: center;
                background-color: #f8fafc;
            }
            .print-card-label { 
                font-size: 9pt; 
                color: #64748b; 
                margin-bottom: 5px; 
                font-family: 'Battambang', sans-serif; 
                font-weight: bold;
            }
            .print-card-value { 
                font-size: 14pt; 
                font-weight: bold; 
                color: #0f172a; 
                font-family: 'Inter', sans-serif;
            }

            /* Table Layout */
            table { 
                width: 100%; 
                border-collapse: collapse; 
                font-size: 10pt; 
            }
            th, td { 
                border: 1px solid #94a3b8; 
                padding: 8px 6px;
                vertical-align: middle;
            }
            th { 
                background-color: #e2e8f0 !important; 
                color: #0f172a; 
                font-family: 'Moul', cursive; 
                font-size: 9pt;
                text-align: center;
                font-weight: normal;
                height: 40px;
            }
            .col-no { width: 5%; text-align: center; }
            .col-name { width: 25%; text-align: left; padding-left: 10px; font-weight: bold; }
            .col-skill { width: 15%; text-align: left; padding-left: 10px; }
            .col-time { width: 15%; text-align: center; font-family: 'Inter', sans-serif; }
            .col-status { width: 15%; text-align: center; font-weight: bold; font-size: 9pt; }
            .col-note { width: 10%; text-align: left; font-style: italic; color: #64748b; font-size: 9pt; }

            .status-present { color: #15803d; }
            .status-permission { color: #b45309; }
            .status-absent { color: #b91c1c; }

            /* Footer */
            .footer-section {
                margin-top: 40px;
                display: flex;
                justify-content: space-between;
                padding: 0 40px;
                page-break-inside: avoid;
            }
            .signature-box {
                text-align: center;
                width: 250px;
            }
            .signature-title {
                font-family: 'Moul', cursive;
                font-size: 10pt;
                margin-bottom: 70px;
                font-weight: normal;
            }
            .signature-line {
                border-top: 1px dotted #000;
                width: 80%;
                margin: 0 auto;
            }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
        import { 
            CheckCircle2, XCircle, Clock, Calendar, Search, UserCheck, LogOut, 
            ChevronLeft, ChevronRight, FileText, Briefcase, Save, X, Loader2, 
            Printer, PieChart, Users, Check, Settings, Filter, Palette, Layout, TrendingUp,
            Moon, Sun, UserPlus, ListChecks
        } from 'https://esm.sh/lucide-react@0.344.0';

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC3pJ5902riWQ_5tSNi2MxznKj3msUtXMg",
            authDomain: "att-e7aba.firebaseapp.com",
            projectId: "att-e7aba",
            storageBucket: "att-e7aba.firebasestorage.app",
            messagingSenderId: "893825794222",
            appId: "1:893825794222:web:3e373a1801af855aecad3f",
            measurementId: "G-0SXDQ6SQMK",
            databaseURL: "https://att-e7aba-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const SHEET_ID = '1g0SQ6C6GQane4htPWPVpiuKA6cS6Wt93orwYT_7MnGE';
        const SHEET_NAME = 'DB';
        const RANGE = 'C3:G'; 

        // --- Helpers ---
        const toKhmerNum = (num) => {
            if (num === undefined || num === null || isNaN(num)) return num || '';
            const str = num.toString();
            const khmerNums = ['·ü†', '·ü°', '·ü¢', '·ü£', '·ü§', '·ü•', '·ü¶', '·üß', '·ü®', '·ü©'];
            return str.replace(/[0-9]/g, (d) => khmerNums[d]);
        };
        const formatTimeKh = (timeStr) => (!timeStr || timeStr === '·ûÖ·üí·ûî·û∂·ûî·üã') ? timeStr : toKhmerNum(timeStr);
        const formatDateKh = (dateStr) => {
            if(!dateStr) return '';
            const date = new Date(dateStr);
            const day = toKhmerNum(date.getDate().toString().padStart(2, '0'));
            const month = toKhmerNum((date.getMonth() + 1).toString().padStart(2, '0'));
            const year = toKhmerNum(date.getFullYear());
            return `·ûê·üí·ûÑ·üÉ·ûë·û∏${day} ·ûÅ·üÇ${month} ·ûÜ·üí·ûì·û∂·üÜ${year}`;
        }
        const getKhmerDay = (dateStr) => {
             const days = ['·û¢·û∂·ûë·û∑·ûè·üí·ûô', '·ûÖ·üê·ûì·üí·ûë', '·û¢·ûÑ·üí·ûÇ·û∂·ûö', '·ûñ·ûª·ûí', '·ûñ·üí·ûö·û†·ûü·üí·ûî·ûè·û∑·üç', '·ûü·ûª·ûÄ·üí·ûö', '·ûü·üÖ·ûö·üç'];
             const date = new Date(dateStr);
             return days[date.getDay()];
        }

        const THEMES = [
            { id: 'blue', name: '·ûÅ·üÄ·ûú', primary: 'bg-blue-600', secondary: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-100', ring: 'ring-blue-500', darkText: 'dark:text-blue-400' },
            { id: 'emerald', name: '·ûî·üÉ·ûè·ûÑ', primary: 'bg-emerald-600', secondary: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-100', ring: 'ring-emerald-500', darkText: 'dark:text-emerald-400' },
            { id: 'violet', name: '·ûü·üí·ûú·û∂·ûô', primary: 'bg-violet-600', secondary: 'bg-violet-50', text: 'text-violet-600', border: 'border-violet-100', ring: 'ring-violet-500', darkText: 'dark:text-violet-400' },
            { id: 'orange', name: '·ûë·ûπ·ûÄ·ûÄ·üí·ûö·ûº·ûÖ', primary: 'bg-orange-500', secondary: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-100', ring: 'ring-orange-500', darkText: 'dark:text-orange-400' },
        ];

        function AttendanceApp() {
            const [employees, setEmployees] = useState([]);
            const [rawAttendanceData, setRawAttendanceData] = useState({}); 
            const [attendanceData, setAttendanceData] = useState({}); 
            const [loading, setLoading] = useState(true);
            
            const [viewMode, setViewMode] = useState('attendance');
            const [currentTheme, setCurrentTheme] = useState(THEMES[0]);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [toast, setToast] = useState(null); 
            const [searchTerm, setSearchTerm] = useState('');

            const [filterMode, setFilterMode] = useState('daily'); 
            const [filterDate, setFilterDate] = useState(new Date().toISOString().split('T')[0]);
            const [filterMonth, setFilterMonth] = useState(new Date().toISOString().slice(0, 7)); 
            const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);

            const [showPermissionModal, setShowPermissionModal] = useState(false);
            const [selectedEmp, setSelectedEmp] = useState(null);
            const [permissionReason, setPermissionReason] = useState('');
            const [permissionType, setPermissionType] = useState('full'); 

            useEffect(() => { fetchEmployees(); }, []);
            useEffect(() => {
                if (isDarkMode) { document.documentElement.classList.add('dark'); } 
                else { document.documentElement.classList.remove('dark'); }
            }, [isDarkMode]);

            useEffect(() => {
                if (filterMode === 'daily') {
                    const unsubscribe = onValue(ref(db, `attendance/${filterDate}`), (snap) => {
                        const val = snap.val() || {};
                        setAttendanceData(val);
                        setRawAttendanceData({ [filterDate]: val });
                    });
                    return () => unsubscribe();
                } else {
                    const unsubscribe = onValue(ref(db, 'attendance'), (snap) => {
                        const allData = snap.val() || {};
                        setRawAttendanceData(allData);
                    });
                    return () => unsubscribe();
                }
            }, [filterMode, filterDate]);

            const showToast = (message, type = 'success') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            };

            const fetchEmployees = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}&range=${RANGE}`);
                    const txt = await res.text();
                    const rows = txt.split('\n').map(row => row.split(',').map(c => c.replace(/"/g, '')));
                    setEmployees(rows.filter(r => r[0]).map((r, i) => ({ id: `emp_${i}`, name: r[0], gender: r[2], skill: r[4] ? r[4].trim() : '·ûë·ûº·ûë·üÖ' })));
                } catch (e) { console.error(e); } finally { setLoading(false); }
            };

            const updateStatus = async (employee, type, reason = '') => {
                const today = new Date().toISOString().split('T')[0];
                const targetDate = filterMode === 'daily' ? filterDate : today;
                const time = new Date().toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute:'2-digit'});
                const key = employee.name.replace(/[.#$/[\]]/g, '_');
                const path = `attendance/${targetDate}/${key}`;
                
                let current = {};
                if (filterMode === 'daily') current = attendanceData[key] || {};
                let data = { ...current, name: employee.name, gender: employee.gender, updatedAt: new Date().toISOString() };

                if (type === 'check-in') { data.status = 'present'; data.checkInTime = time; showToast(`‚úÖ ${employee.name} ·ûî·û∂·ûì Check-in`); }
                else if (type === 'check-out') { data.checkOutTime = time; showToast(`üëã ${employee.name} ·ûî·û∂·ûì Check-out`); }
                else if (type === 'absent') { data.status = 'absent'; showToast(`‚ö†Ô∏è ${employee.name} ·ûè·üí·ûö·ûº·ûú·ûî·û∂·ûì·ûÄ·ûè·üã·ûè·üí·ûö·û∂·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì`, 'error'); }

                try { await update(ref(db), { [path]: data }); } catch (e) { showToast("·ûî·ûö·û∂·ûá·üê·ûô·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ", "error"); }
            };

            const updatePermission = async () => {
                if (!selectedEmp) return;
                const today = new Date().toISOString().split('T')[0];
                const targetDate = filterMode === 'daily' ? filterDate : today;
                const key = selectedEmp.name.replace(/[.#$/[\]]/g, '_');
                const path = `attendance/${targetDate}/${key}`;
                let current = attendanceData[key] || {};
                
                let data = { ...current, name: selectedEmp.name, gender: selectedEmp.gender, updatedAt: new Date().toISOString(), reason: permissionReason };

                if (permissionType === 'full') { data.status = 'permission'; data.checkInTime = '·ûÖ·üí·ûî·û∂·ûî·üã'; data.checkOutTime = '·ûÖ·üí·ûî·û∂·ûî·üã'; } 
                else if (permissionType === 'check-in') { if (!data.status) data.status = 'permission'; data.checkInTime = '·ûÖ·üí·ûî·û∂·ûî·üã'; } 
                else if (permissionType === 'check-out') { if (!data.status) data.status = 'permission'; data.checkOutTime = '·ûÖ·üí·ûî·û∂·ûî·üã'; }

                try { 
                    await update(ref(db), { [path]: data }); 
                    showToast(`üìù ·ûî·û∂·ûì·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûÖ·üí·ûî·û∂·ûî·üã·ûü·ûò·üí·ûö·û∂·ûî·üã ${selectedEmp.name}`);
                    setShowPermissionModal(false);
                } catch (e) { showToast("·ûî·ûö·û∂·ûá·üê·ûô·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ", "error"); }
            };

            const aggregatedStats = useMemo(() => {
                let records = [];
                if (filterMode === 'daily') { records = Object.values(attendanceData); } 
                else {
                    Object.keys(rawAttendanceData).forEach(dateKey => {
                        let include = false;
                        if (filterMode === 'monthly' && dateKey.startsWith(filterMonth)) include = true;
                        if (filterMode === 'range' && dateKey >= startDate && dateKey <= endDate) include = true;
                        if (include) records = [...records, ...Object.values(rawAttendanceData[dateKey])];
                    });
                }

                const total = employees.length;
                const presentCount = records.filter(r => r.status === 'present').length;
                const permissionCount = records.filter(r => r.status === 'permission').length;
                const absentCount = records.filter(r => r.status === 'absent').length;

                const skills = [...new Set(employees.map(e => e.skill))];
                const skillStats = skills.map(skill => {
                    const skillEmps = employees.filter(e => e.skill === skill).map(e => e.name);
                    const skillRecords = records.filter(r => skillEmps.includes(r.name));
                    const completed = skillRecords.filter(r => r.status === 'present' && r.checkInTime && r.checkOutTime).length;
                    const pending = skillRecords.filter(r => r.status === 'present' && r.checkInTime && !r.checkOutTime).length;
                    return { skill, completed, pending, totalEmps: skillEmps.length };
                });

                let reportRecords = records.filter(r => r.status === 'present' || r.status === 'permission' || r.status === 'absent');
                reportRecords.sort((a, b) => a.name.localeCompare(b.name));

                return { total, presentCount, permissionCount, absentCount, skillStats, reportRecords };
            }, [employees, attendanceData, rawAttendanceData, filterMode, filterMonth, startDate, endDate]);

            const changeDate = (d) => {
                const date = new Date(filterDate);
                date.setDate(date.getDate() + d);
                setFilterDate(date.toISOString().split('T')[0]);
            };

            const pendingList = employees.filter(emp => {
                const key = emp.name.replace(/[.#$/[\]]/g, '_');
                const rec = attendanceData[key];
                const matchesSearch = emp.name.toLowerCase().includes(searchTerm.toLowerCase());
                return (!rec || !rec.status) && matchesSearch; 
            });

            const activeList = employees.filter(emp => {
                const key = emp.name.replace(/[.#$/[\]]/g, '_');
                const rec = attendanceData[key];
                return rec && (rec.status === 'present' || rec.status === 'permission' || rec.status === 'absent');
            });

            return (
                <div className={`min-h-screen bg-slate-50 dark:bg-slate-950 pb-24 flex flex-col font-sans transition-colors duration-300`}>
                    
                    {/* Header (Hidden in Print) */}
                    <header className="sticky top-0 z-30 px-5 py-4 glass-panel no-print">
                        <div className="max-w-md mx-auto w-full">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className={`text-2xl font-extrabold font-khmer tracking-tight flex items-center gap-2 text-slate-800 dark:text-slate-100`}>
                                    <div className={`w-10 h-10 ${currentTheme.primary} rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200/50 dark:shadow-none`}>
                                        <Briefcase size={20} strokeWidth={2.5}/>
                                    </div>
                                    HR Admin
                                </h1>
                                {filterMode !== 'daily' && (
                                    <span className={`text-[10px] font-bold px-3 py-1 rounded-full ${currentTheme.secondary} ${currentTheme.text} dark:bg-slate-800 ${currentTheme.darkText} border ${currentTheme.border} dark:border-slate-700 font-khmer`}>
                                        {filterMode === 'monthly' ? '·ûî·üí·ûö·ûÖ·û∂·üÜ·ûÅ·üÇ' : '·ûÖ·ûì·üí·ûõ·üÑ·üá·ûê·üí·ûÑ·üÉ'}
                                    </span>
                                )}
                            </div>
                            
                            {/* Date Display Logic - Updated to be static for attendance view */}
                            {viewMode === 'attendance' ? (
                                <div className="w-full bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-slate-100 dark:border-slate-700 text-center transition-colors">
                                    <div className="text-xs text-slate-400 font-bold uppercase tracking-wider font-khmer mb-1">·ûÄ·û∂·ûõ·ûî·ûö·û∑·ûÖ·üí·ûÜ·üÅ·ûë·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá</div>
                                    <div className={`text-xl font-bold ${currentTheme.text} ${currentTheme.darkText} font-khmer tracking-wide`}>{formatDateKh(new Date().toISOString().split('T')[0])}</div>
                                </div>
                            ) : (
                                filterMode === 'daily' && (
                                    <div className="flex items-center justify-between bg-white dark:bg-slate-800 rounded-2xl p-1.5 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
                                        <button onClick={() => changeDate(-1)} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-400 hover:text-blue-600 transition-all"><ChevronLeft size={24}/></button>
                                        <div className="flex flex-col items-center">
                                            <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider font-khmer">·ûÄ·û∂·ûõ·ûî·ûö·û∑·ûÖ·üí·ûÜ·üÅ·ûë</span>
                                            <span className="text-base font-bold text-slate-700 dark:text-slate-200 font-khmer tracking-wide">{formatDateKh(filterDate)}</span>
                                        </div>
                                        <button onClick={() => changeDate(1)} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-400 hover:text-blue-600 transition-all"><ChevronRight size={24}/></button>
                                    </div>
                                )
                            )}
                        </div>
                    </header>

                    <main className="flex-1 max-w-md mx-auto w-full p-5 space-y-6 print-container">
                        
                        {/* 1. PENDING VIEW (Attendance) */}
                        {viewMode === 'attendance' && (
                            <div className="animate-fade-in space-y-5 no-print">
                                {filterMode !== 'daily' && <div className="bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800 text-orange-600 dark:text-orange-400 p-3 rounded-xl text-xs font-bold text-center mb-2 font-khmer">‚ö†Ô∏è ·ûü·ûº·ûò·ûî·üí·ûè·ûº·ûö·ûë·üÖ "·ûî·üí·ûö·ûÖ·û∂·üÜ·ûê·üí·ûÑ·üÉ" ·ûä·ûæ·ûò·üí·ûî·û∏ Check-in</div>}
                                
                                {/* Search Bar Added Back */}
                                <div className="relative">
                                    <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400" size={20} />
                                    <input 
                                        type="text" 
                                        className="w-full pl-12 pr-4 py-4 bg-white dark:bg-slate-800 rounded-2xl border-none outline-none font-khmer text-slate-700 dark:text-slate-200 shadow-sm focus:ring-2 focus:ring-primary/20 transition-all"
                                        placeholder="·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ·ûà·üí·ûò·üÑ·üá·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>

                                <div className="flex items-center justify-between px-1">
                                    <h2 className="font-bold text-lg text-slate-700 dark:text-slate-200 font-khmer">·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·ûÄ</h2>
                                    <span className="bg-slate-100 dark:bg-slate-800 text-slate-500 text-xs px-3 py-1 rounded-full font-bold">{toKhmerNum(pendingList.length)} ·ûì·û∂·ûÄ·üã</span>
                                </div>

                                {loading ? (
                                    <div className="flex justify-center py-10"><Loader2 className={`animate-spin ${currentTheme.text} dark:text-white`} size={32}/></div>
                                ) : pendingList.length === 0 ? (
                                    <div className="text-center py-10 text-slate-400 font-khmer">·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã·ûî·û∂·ûì Check-in ·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã! üéâ</div>
                                ) : (
                                    <div className="space-y-4 pb-20">
                                        {pendingList.map((emp, index) => (
                                            <div key={emp.id} className="bg-white dark:bg-slate-800 rounded-3xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)] dark:shadow-none border border-slate-100 dark:border-slate-700 overflow-hidden relative animate-slide-up transition-transform hover:scale-[1.01]" style={{animationDelay: `${index * 50}ms`}}>
                                                <div className="p-5">
                                                    <div className="flex items-center gap-4 mb-6">
                                                        <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-md ${emp.gender === '·ûü·üí·ûö·û∏' ? 'bg-gradient-to-br from-pink-400 to-rose-500' : 'bg-gradient-to-br from-blue-500 to-indigo-600'}`}>
                                                            {emp.name.charAt(0)}
                                                        </div>
                                                        <div>
                                                            <h3 className="font-bold text-lg text-slate-800 dark:text-slate-100 font-khmer leading-tight mb-1">{emp.name}</h3>
                                                            <span className="inline-block text-[10px] font-medium text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-700/50 px-2 py-0.5 rounded-md font-khmer">{emp.skill}</span>
                                                        </div>
                                                    </div>

                                                    {/* Actions */}
                                                    {filterMode === 'daily' && (
                                                        <div className="space-y-3">
                                                            <button onClick={() => updateStatus(emp, 'check-in')} className="w-full bg-slate-900 dark:bg-white dark:text-slate-900 text-white h-12 rounded-2xl font-bold text-sm shadow-lg shadow-slate-200 dark:shadow-none active:scale-95 transition-all flex items-center justify-center gap-2 font-khmer">
                                                                <CheckCircle2 size={18} /> Check In
                                                            </button>
                                                            <div className="flex justify-between items-center px-1 pt-1">
                                                                <button onClick={() => {setSelectedEmp(emp); setPermissionReason(''); setPermissionType('full'); setShowPermissionModal(true);}} 
                                                                    className="text-xs font-bold text-slate-400 hover:text-amber-500 transition-colors flex items-center gap-1.5 bg-slate-50 dark:bg-slate-700/50 px-3 py-1.5 rounded-lg font-khmer">
                                                                    <FileText size={14}/> ·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã
                                                                </button>
                                                                <button onClick={() => updateStatus(emp, 'absent')} 
                                                                    className="text-xs font-bold text-slate-400 hover:text-rose-500 transition-colors flex items-center gap-1.5 bg-slate-50 dark:bg-slate-700/50 px-3 py-1.5 rounded-lg font-khmer">
                                                                    <XCircle size={14}/> ·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* 2. ACTIVE VIEW (Working/Processed) */}
                        {viewMode === 'working' && (
                            <div className="animate-fade-in space-y-5 no-print">
                                <div className="flex items-center justify-between px-1">
                                    <h2 className="font-bold text-lg text-slate-700 dark:text-slate-200 font-khmer">·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ·ûî·û∂·ûì·ûò·ûÄ / ·ûÖ·üí·ûî·û∂·ûî·üã</h2>
                                    <span className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 text-xs px-3 py-1 rounded-full font-bold">{toKhmerNum(activeList.length)} ·ûì·û∂·ûÄ·üã</span>
                                </div>

                                <div className="space-y-4 pb-20">
                                    {activeList.map((emp, index) => {
                                        const key = emp.name.replace(/[.#$/[\]]/g, '_');
                                        const rec = filterMode === 'daily' ? (attendanceData[key] || {}) : {};
                                        
                                        const hasCheckIn = !!rec.checkInTime;
                                        const hasCheckOut = !!rec.checkOutTime;
                                        const isPermissionIn = rec.checkInTime === '·ûÖ·üí·ûî·û∂·ûî·üã';
                                        const isPermissionOut = rec.checkOutTime === '·ûÖ·üí·ûî·û∂·ûî·üã';
                                        
                                        return (
                                            <div key={emp.id} className="bg-white dark:bg-slate-800 rounded-3xl shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)] dark:shadow-none border border-slate-100 dark:border-slate-700 overflow-hidden relative animate-slide-up" style={{animationDelay: `${index * 50}ms`}}>
                                                
                                                {/* Status Badge */}
                                                <div className={`absolute top-4 right-4 px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider font-khmer ${
                                                    rec.status === 'present' ? 'bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400' : 
                                                    rec.status === 'permission' ? 'bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400' : 'bg-rose-50 text-rose-600 dark:bg-rose-900/30 dark:text-rose-400'
                                                }`}>
                                                    {rec.status === 'present' ? '·ûú·ûè·üí·ûè·ûò·û∂·ûì' : rec.status === 'permission' ? '·ûÖ·üí·ûî·û∂·ûî·üã' : '·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì'}
                                                </div>

                                                <div className="p-5">
                                                    {/* Header */}
                                                    <div className="flex items-center gap-4 mb-6">
                                                        <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-lg ${emp.gender === '·ûü·üí·ûö·û∏' ? 'bg-gradient-to-br from-pink-400 to-rose-500' : 'bg-gradient-to-br from-blue-500 to-indigo-600'}`}>
                                                            {emp.name.charAt(0)}
                                                        </div>
                                                        <div>
                                                            <h3 className="font-bold text-lg text-slate-800 dark:text-slate-100 font-khmer leading-tight mb-1">{emp.name}</h3>
                                                            <span className="inline-block text-[10px] font-medium text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-700/50 px-2 py-0.5 rounded-md font-khmer">{emp.skill}</span>
                                                        </div>
                                                    </div>

                                                    {/* Time Grid */}
                                                    <div className="grid grid-cols-2 gap-3 mb-5">
                                                        <div className={`p-3 rounded-2xl border flex flex-col items-center justify-center h-20 ${hasCheckIn ? (isPermissionIn ? 'bg-amber-50 border-amber-100 dark:bg-amber-900/10 dark:border-amber-900/20' : 'bg-emerald-50 border-emerald-100 dark:bg-emerald-900/10 dark:border-emerald-900/20') : 'bg-slate-50 border-slate-100 dark:bg-slate-700/30 dark:border-slate-700'}`}>
                                                            <span className="text-[10px] text-slate-400 font-bold mb-1 uppercase font-khmer">·ûò·üâ·üÑ·ûÑ·ûÖ·ûº·ûõ</span>
                                                            <span className={`font-bold text-lg ${
                                                                isPermissionIn ? 'text-amber-600 font-khmer text-sm' : 
                                                                hasCheckIn ? 'text-emerald-700 dark:text-emerald-400 font-khmer' : 'text-slate-300 font-khmer'
                                                            }`}>
                                                                {formatTimeKh(rec.checkInTime) || '--:--'}
                                                            </span>
                                                        </div>
                                                        <div className={`p-3 rounded-2xl border flex flex-col items-center justify-center h-20 ${hasCheckOut ? (isPermissionOut ? 'bg-amber-50 border-amber-100 dark:bg-amber-900/10 dark:border-amber-900/20' : 'bg-blue-50 border-blue-100 dark:bg-blue-900/10 dark:border-blue-900/20') : 'bg-slate-50 border-slate-100 dark:bg-slate-700/30 dark:border-slate-700'}`}>
                                                            <span className="text-[10px] text-slate-400 font-bold mb-1 uppercase font-khmer">·ûò·üâ·üÑ·ûÑ·ûÖ·üÅ·ûâ</span>
                                                            <span className={`font-bold text-lg ${
                                                                isPermissionOut ? 'text-amber-600 font-khmer text-sm' :
                                                                hasCheckOut ? 'text-blue-700 dark:text-blue-400 font-khmer' : 'text-slate-300 font-khmer'
                                                            }`}>
                                                                {formatTimeKh(rec.checkOutTime) || '--:--'}
                                                            </span>
                                                        </div>
                                                    </div>

                                                    {/* Actions (Check Out) */}
                                                    {filterMode === 'daily' && (
                                                        <div className="space-y-3">
                                                            {!hasCheckOut && rec.status === 'present' && (
                                                                <button onClick={() => updateStatus(emp, 'check-out')} className={`w-full h-12 rounded-2xl font-bold text-sm border-2 flex items-center justify-center gap-2 transition-all active:scale-95 font-khmer bg-white dark:bg-slate-800 border-blue-600 text-blue-600 dark:text-blue-400 hover:bg-blue-50`}>
                                                                    <LogOut size={18} /> Check Out
                                                                </button>
                                                            )}
                                                            {hasCheckOut && (
                                                                <div className="w-full py-3 rounded-xl bg-slate-100 dark:bg-slate-700/50 text-slate-400 text-center font-bold text-sm flex items-center justify-center gap-2 font-khmer">
                                                                    <Check size={16}/> ·ûî·ûâ·üí·ûÖ·ûî·üã·ûÄ·û∂·ûö·ûÑ·û∂·ûö
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {activeList.length === 0 && (
                                        <div className="text-center py-10 text-slate-400 font-khmer">·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ·ûò·ûÄ·ûë·üÅ</div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* 3. SUMMARY VIEW */}
                        {viewMode === 'summary' && (
                            <div className="animate-fade-in space-y-6 pb-20 no-print">
                                {/* Total Card */}
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 dark:from-slate-900 dark:to-black rounded-[32px] p-6 text-white shadow-xl relative overflow-hidden">
                                    <div className="relative z-10">
                                        <p className="text-slate-400 text-sm font-khmer mb-1">·ûü·ûö·ûª·ûî·ûú·ûè·üí·ûè·ûò·û∂·ûì ({filterMode === 'daily' ? formatDateKh(filterDate) : 'Filter'})</p>
                                        <h2 className="text-5xl font-extrabold tracking-tight font-khmer">{toKhmerNum(aggregatedStats.presentCount)}</h2>
                                    </div>
                                    <div className="absolute right-0 top-0 opacity-10 p-4"><PieChart size={120}/></div>
                                </div>

                                {/* Stats Grid (Restored) */}
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col items-center">
                                        <span className="text-2xl font-extrabold text-emerald-600 font-khmer">{toKhmerNum(aggregatedStats.presentCount)}</span>
                                        <span className="text-xs text-slate-500 font-khmer">·ûú·ûè·üí·ûè·ûò·û∂·ûì</span>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col items-center">
                                        <span className="text-2xl font-extrabold text-amber-600 font-khmer">{toKhmerNum(aggregatedStats.permissionCount)}</span>
                                        <span className="text-xs text-slate-500 font-khmer">·ûÖ·üí·ûî·û∂·ûî·üã</span>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col items-center">
                                        <span className="text-2xl font-extrabold text-rose-600 font-khmer">{toKhmerNum(aggregatedStats.absentCount)}</span>
                                        <span className="text-xs text-slate-500 font-khmer">·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì</span>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col items-center">
                                        <span className="text-2xl font-extrabold text-slate-700 dark:text-slate-200 font-khmer">{toKhmerNum(aggregatedStats.total)}</span>
                                        <span className="text-xs text-slate-500 font-khmer">·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ·ûü·ûö·ûª·ûî</span>
                                    </div>
                                </div>

                                {/* Skill Breakdown (Restored) */}
                                <div className="space-y-4">
                                    <h3 className="text-lg font-bold text-slate-800 dark:text-slate-100 font-khmer flex items-center gap-2">
                                        <TrendingUp size={20} className={`${currentTheme.text} ${currentTheme.darkText}`}/> ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûè·û∂·ûò·ûá·üÜ·ûì·û∂·ûâ
                                    </h3>
                                    {aggregatedStats.skillStats.map((stat, idx) => (
                                        <div key={idx} className="bg-white dark:bg-slate-800 rounded-[24px] p-5 shadow-sm border border-slate-100 dark:border-slate-700 animate-slide-up" style={{animationDelay: `${idx*50}ms`}}>
                                            <div className="flex justify-between items-center mb-4">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-xl ${currentTheme.secondary} dark:bg-slate-700 ${currentTheme.text} ${currentTheme.darkText} flex items-center justify-center font-bold text-lg font-khmer`}>
                                                        {stat.skill.charAt(0)}
                                                    </div>
                                                    <div>
                                                        <h4 className="font-bold text-slate-800 dark:text-slate-100 font-khmer text-base">{stat.skill}</h4>
                                                        <p className="text-xs text-slate-400 font-khmer">{toKhmerNum(stat.totalEmps)} ·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                <div className="relative">
                                                    <div className="flex justify-between text-xs mb-1">
                                                        <span className="text-slate-500 dark:text-slate-400 font-khmer">·ûÄ·üÜ·ûñ·ûª·ûÑ·ûí·üí·ûú·ûæ·ûÄ·û∂·ûö</span>
                                                        <span className="font-bold text-blue-600 dark:text-blue-400 font-khmer">{toKhmerNum(stat.pending)}</span>
                                                    </div>
                                                    <div className="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2.5 overflow-hidden">
                                                        <div className="bg-blue-500 h-2.5 rounded-full" style={{width: `${(stat.pending / (stat.totalEmps || 1)) * 100}%`}}></div>
                                                    </div>
                                                </div>
                                                <div className="relative">
                                                    <div className="flex justify-between text-xs mb-1">
                                                        <span className="text-slate-500 dark:text-slate-400 font-khmer">·ûî·û∂·ûì·ûî·ûâ·üí·ûÖ·ûî·üã</span>
                                                        <span className="font-bold text-emerald-600 dark:text-emerald-400 font-khmer">{toKhmerNum(stat.completed)}</span>
                                                    </div>
                                                    <div className="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2.5 overflow-hidden">
                                                        <div className="bg-emerald-500 h-2.5 rounded-full" style={{width: `${(stat.completed / (stat.totalEmps || 1)) * 100}%`}}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 4. REPORT VIEW (A4 PRINT) */}
                        {viewMode === 'report' && (
                            <div className="bg-white rounded-[32px] shadow-sm border border-slate-200 overflow-hidden animate-fade-in mb-20">
                                <div className="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center no-print">
                                    <div>
                                        <h3 className="font-bold text-slate-800 font-khmer text-lg">Preview ·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç</h3>
                                        <p className="text-xs text-slate-400 mt-1 font-khmer">{filterMode === 'daily' ? formatDateKh(filterDate) : '·ûÖ·ûì·üí·ûõ·üÑ·üá·ûê·üí·ûÑ·üÉ'}</p>
                                    </div>
                                    <button onClick={() => window.print()} className={`bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg active:scale-95 transition-transform flex items-center gap-2 font-khmer`}>
                                        <Printer size={18}/> Print
                                    </button>
                                </div>
                                
                                {/* PRINT SECTION */}
                                <div className="print-only">
                                    <div className="print-header">
                                        <div className="national-motto">
                                            <h3>·ûñ·üí·ûö·üá·ûö·û∂·ûá·û∂·ûé·û∂·ûÖ·ûÄ·üí·ûö·ûÄ·ûò·üí·ûñ·ûª·ûá·û∂</h3>
                                            <h2>·ûá·û∂·ûè·û∑ ·ûü·û∂·ûü·ûì·û∂ ·ûñ·üí·ûö·üá·ûò·û†·û∂·ûÄ·üí·ûü·ûè·üí·ûö</h2>
                                        </div>
                                        <h1 className="report-title">·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûú·ûè·üí·ûè·ûò·û∂·ûì·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ·ûî·üí·ûö·ûÖ·û∂·üÜ·ûê·üí·ûÑ·üÉ</h1>
                                        <div className="doc-info">
                                            <div style={{fontWeight: 'bold', color: '#2563eb'}}>HR Admin</div>
                                            <div>·ûê·üí·ûÑ·üÉ{getKhmerDay(filterMode === 'daily' ? filterDate : new Date())} {filterMode === 'daily' ? formatDateKh(filterDate) : `${formatDateKh(startDate)} ·ûä·ûõ·üã ${formatDateKh(endDate)}`}</div>
                                        </div>
                                    </div>

                                    <div className="print-summary-grid">
                                        <div className="print-card">
                                            <div className="print-card-label">·ûü·ûö·ûª·ûî</div>
                                            <div className="print-card-value">{toKhmerNum(aggregatedStats.total)}</div>
                                        </div>
                                        <div className="print-card">
                                            <div className="print-card-label">·ûú·ûè·üí·ûè·ûò·û∂·ûì</div>
                                            <div className="print-card-value" style={{color:'#15803d'}}>{toKhmerNum(aggregatedStats.presentCount)}</div>
                                        </div>
                                        <div className="print-card">
                                            <div className="print-card-label">·ûÖ·üí·ûî·û∂·ûî·üã</div>
                                            <div className="print-card-value" style={{color:'#b45309'}}>{toKhmerNum(aggregatedStats.permissionCount)}</div>
                                        </div>
                                        <div className="print-card">
                                            <div className="print-card-label">·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì</div>
                                            <div className="print-card-value" style={{color:'#b91c1c'}}>{toKhmerNum(aggregatedStats.absentCount)}</div>
                                        </div>
                                    </div>

                                    <table>
                                        <thead>
                                            <tr>
                                                <th className="col-no">·ûõ.·ûö</th>
                                                <th className="col-name">·ûà·üí·ûò·üÑ·üá·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ</th>
                                                <th className="col-skill">·ûá·üÜ·ûì·û∂·ûâ</th>
                                                <th className="col-time">·ûÖ·ûº·ûõ</th>
                                                <th className="col-time">·ûÖ·üÅ·ûâ</th>
                                                <th className="col-status">·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ</th>
                                                <th className="col-note">·ûï·üí·ûü·üÅ·ûÑ·üó</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {aggregatedStats.reportRecords.length === 0 ? (
                                                <tr><td colSpan="7" style={{textAlign: 'center', padding: '20px'}}>·ûÇ·üí·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô</td></tr>
                                            ) : (
                                                aggregatedStats.reportRecords.map((rec, i) => (
                                                    <tr key={i}>
                                                        <td className="col-no">{toKhmerNum(i + 1)}</td>
                                                        <td className="col-name">{rec.name}</td>
                                                        <td className="col-skill">{employees.find(e=>e.name===rec.name)?.skill || '-'}</td>
                                                        <td className="col-time">{formatTimeKh(rec.checkInTime) || '-'}</td>
                                                        <td className="col-time">{formatTimeKh(rec.checkOutTime) || '-'}</td>
                                                        <td className="col-status font-khmer">
                                                            {rec.status === 'present' ? '·ûú·ûè·üí·ûè·ûò·û∂·ûì' : rec.status === 'permission' ? '·ûÖ·üí·ûî·û∂·ûî·üã' : '·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì'}
                                                        </td>
                                                        <td className="col-note font-khmer">{rec.reason || ''}</td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>

                                    <div className="footer-section">
                                        <div className="signature-box">
                                            <div className="signature-title">·ûö·üÄ·ûî·ûÖ·üÜ·ûä·üÑ·ûô</div>
                                            <div className="signature-line"></div>
                                        </div>
                                        <div className="signature-box">
                                            <div className="signature-title">·ûñ·û∑·ûì·û∑·ûè·üí·ûô ·ûì·û∑·ûÑ·ûØ·ûÄ·ûó·û∂·ûñ·ûä·üÑ·ûô</div>
                                            <div className="signature-line"></div>
                                        </div>
                                    </div>
                                </div>

                                <div className="overflow-x-auto no-print">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                                            <tr>
                                                <th className="p-3 font-khmer pl-6 text-left">·ûà·üí·ûò·üÑ·üá</th>
                                                <th className="p-3 font-khmer text-left">·ûá·üÜ·ûì·û∂·ûâ</th>
                                                <th className="p-3 text-center font-khmer">·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {aggregatedStats.reportRecords.map((rec, i) => (
                                                <tr key={i} className="hover:bg-slate-50">
                                                    <td className="p-3 font-bold text-slate-700 font-khmer pl-6">{rec.name}</td>
                                                    <td className="p-3 text-slate-500 text-xs font-khmer">{employees.find(e=>e.name===rec.name)?.skill || '-'}</td>
                                                    <td className="p-3 text-center"><span className="bg-slate-100 px-2 py-1 rounded text-xs font-bold uppercase font-khmer">{rec.status === 'present' ? '·ûú·ûè·üí·ûè·ûò·û∂·ûì' : rec.status === 'permission' ? '·ûÖ·üí·ûî·û∂·ûî·üã' : '·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì'}</span></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* 5. SETTINGS VIEW (Restored Features) */}
                        {viewMode === 'settings' && (
                            <div className="animate-fade-in space-y-6 pb-20 no-print">
                                <h2 className="font-bold text-xl text-slate-800 dark:text-slate-100 font-khmer px-1">·ûÄ·û∂·ûö·ûÄ·üÜ·ûé·ûè·üã</h2>
                                {/* Appearance */}
                                <div className="bg-white dark:bg-slate-800 p-6 rounded-[32px] shadow-sm border border-slate-100 dark:border-slate-700">
                                    <h3 className="font-bold text-slate-700 dark:text-slate-200 font-khmer mb-4 flex items-center gap-2"><Layout size={20}/> ·ûö·ûº·ûî·ûö·û∂·ûÑ</h3>
                                    <div className="flex gap-3">
                                        <button onClick={() => setIsDarkMode(false)} className={`flex-1 py-3 rounded-2xl border flex items-center justify-center gap-2 transition-all font-khmer ${!isDarkMode ? 'bg-slate-100 border-slate-300 text-slate-800' : 'border-slate-200 text-slate-400'}`}><Sun size={18}/> ·ûñ·ûé·üå·ûê·üí·ûÑ·üÉ</button>
                                        <button onClick={() => setIsDarkMode(true)} className={`flex-1 py-3 rounded-2xl border flex items-center justify-center gap-2 transition-all font-khmer ${isDarkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-200 text-slate-400'}`}><Moon size={18}/> ·ûñ·ûé·üå·ûô·ûî·üã</button>
                                    </div>
                                </div>
                                {/* Theme Palette (Restored) */}
                                <div className="bg-white dark:bg-slate-800 p-6 rounded-[32px] shadow-sm border border-slate-100 dark:border-slate-700">
                                    <h3 className="font-bold text-slate-700 dark:text-slate-200 font-khmer mb-4 flex items-center gap-2"><Palette size={20}/> ·ûñ·ûé·üå·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏</h3>
                                    <div className="grid grid-cols-4 gap-3">
                                        {THEMES.map(theme => (
                                            <button key={theme.id} onClick={() => setCurrentTheme(theme)} className={`aspect-square rounded-2xl flex items-center justify-center transition-all ${currentTheme.id === theme.id ? 'ring-2 ring-offset-2 ring-slate-900 dark:ring-slate-400' : ''} ${theme.secondary} dark:bg-slate-700`}>
                                                <div className={`w-6 h-6 rounded-full ${theme.primary}`}></div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                {/* Filters */}
                                <div className="bg-white dark:bg-slate-800 p-6 rounded-[32px] shadow-sm border border-slate-100 dark:border-slate-700">
                                    <h3 className="font-bold text-slate-700 dark:text-slate-200 font-khmer mb-4 flex items-center gap-2"><Filter size={20}/> Filter ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô</h3>
                                    <div className="flex bg-slate-100 dark:bg-slate-700 p-1.5 rounded-2xl mb-5">
                                        {['daily', 'monthly', 'range'].map(mode => (
                                            <button key={mode} onClick={() => setFilterMode(mode)} className={`flex-1 py-2.5 rounded-xl text-xs font-bold capitalize transition-all font-khmer ${filterMode === mode ? 'bg-white dark:bg-slate-600 shadow text-slate-900 dark:text-white' : 'text-slate-400'}`}>{mode === 'daily' ? '·ûî·üí·ûö·ûÖ·û∂·üÜ·ûê·üí·ûÑ·üÉ' : mode === 'monthly' ? '·ûî·üí·ûö·ûÖ·û∂·üÜ·ûÅ·üÇ' : '·ûÖ·ûì·üí·ûõ·üÑ·üá·ûê·üí·ûÑ·üÉ'}</button>
                                        ))}
                                    </div>
                                    {filterMode === 'daily' && <input type="date" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="w-full p-4 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-2xl border-none outline-none font-mono text-slate-700"/>}
                                    {filterMode === 'monthly' && <input type="month" value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)} className="w-full p-4 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-2xl border-none outline-none font-mono text-slate-700"/>}
                                    {filterMode === 'range' && (
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="w-full p-4 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-2xl border-none outline-none font-mono text-slate-700"/>
                                            <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="w-full p-4 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-2xl border-none outline-none font-mono text-slate-700"/>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Navbar */}
                    <nav className="fixed bottom-5 left-5 right-5 h-[72px] glass-panel rounded-[24px] shadow-2xl shadow-slate-200/50 dark:shadow-none z-40 no-print flex items-center justify-around px-1 safe-area-bottom">
                        <NavBtn icon={<UserPlus size={22}/>} label="·ûú·ûè·üí·ûè·ûò·û∂·ûì" active={viewMode==='attendance'} onClick={() => setViewMode('attendance')} theme={currentTheme}/>
                        <NavBtn icon={<ListChecks size={22}/>} label="·ûî·û∂·ûì·ûò·ûÄ" active={viewMode==='working'} onClick={() => setViewMode('working')} theme={currentTheme}/>
                        <NavBtn icon={<PieChart size={22}/>} label="·ûü·ûö·ûª·ûî" active={viewMode==='summary'} onClick={() => setViewMode('summary')} theme={currentTheme}/>
                        <NavBtn icon={<FileText size={22}/>} label="·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç" active={viewMode==='report'} onClick={() => setViewMode('report')} theme={currentTheme}/>
                        <NavBtn icon={<Settings size={22}/>} label="·ûÄ·üÜ·ûé·ûè·üã" active={viewMode==='settings'} onClick={() => setViewMode('settings')} theme={currentTheme}/>
                    </nav>

                    {/* Toast & Modal */}
                    {toast && <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3.5 rounded-full shadow-2xl flex items-center gap-3 bg-slate-900 dark:bg-white dark:text-slate-900 text-white animate-fade-in"><CheckCircle2 size={18}/><span className="font-bold font-khmer text-sm">{toast.message}</span></div>}
                    {showPermissionModal && (
                        <div className="fixed inset-0 z-50 bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-6 no-print animate-fade-in">
                            <div className="bg-white dark:bg-slate-800 rounded-[32px] w-full max-w-sm p-6 shadow-2xl border border-white/50 dark:border-slate-600">
                                <h3 className="font-bold text-xl mb-4 font-khmer text-slate-800 dark:text-white">·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã: {selectedEmp?.name}</h3>
                                <div className="space-y-2 mb-4">
                                    <label className="text-xs font-bold text-slate-400 uppercase font-khmer">·ûî·üí·ûö·ûó·üÅ·ûë·ûÖ·üí·ûî·û∂·ûî·üã</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        <button onClick={() => setPermissionType('full')} className={`py-2 rounded-xl text-xs font-bold transition-all font-khmer ${permissionType === 'full' ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-slate-50 text-slate-500 border border-slate-100 dark:bg-slate-700 dark:border-slate-600'}`}>·ûñ·üÅ·ûâ·ûò·ûΩ·ûô·ûê·üí·ûÑ·üÉ</button>
                                        <button onClick={() => setPermissionType('check-in')} className={`py-2 rounded-xl text-xs font-bold transition-all font-khmer ${permissionType === 'check-in' ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-slate-50 text-slate-500 border border-slate-100 dark:bg-slate-700 dark:border-slate-600'}`}>Check In</button>
                                        <button onClick={() => setPermissionType('check-out')} className={`py-2 rounded-xl text-xs font-bold transition-all font-khmer ${permissionType === 'check-out' ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-slate-50 text-slate-500 border border-slate-100 dark:bg-slate-700 dark:border-slate-600'}`}>Check Out</button>
                                    </div>
                                </div>
                                <textarea className="w-full p-4 bg-slate-50 dark:bg-slate-700 rounded-2xl outline-none font-khmer text-sm mb-4 resize-none h-24 focus:ring-2 focus:ring-blue-100 dark:text-white dark:focus:ring-slate-600 transition-all" placeholder="·ûò·ûº·ûõ·û†·üÅ·ûè·ûª..." value={permissionReason} onChange={e=>setPermissionReason(e.target.value)} autoFocus/>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowPermissionModal(false)} className="flex-1 py-3.5 rounded-2xl text-slate-500 dark:text-slate-300 font-bold text-sm bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 transition-colors font-khmer">·ûî·üÑ·üá·ûî·ûÑ·üã</button>
                                    <button onClick={updatePermission} className={`flex-1 py-3.5 rounded-2xl text-white font-bold text-sm ${currentTheme.primary} shadow-lg shadow-blue-200 dark:shadow-none transition-transform active:scale-95 font-khmer`}>·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const NavBtn = ({ icon, label, active, onClick, theme }) => (
            <button onClick={onClick} className="relative w-16 h-full flex flex-col items-center justify-center gap-1.5 group">
                <div className={`p-2.5 rounded-2xl transition-all duration-300 ${active ? `${theme.primary} text-white -translate-y-4 shadow-lg ring-4 ring-white dark:ring-slate-800` : 'text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>{icon}</div>
                <span className={`text-[9px] font-bold font-khmer transition-all duration-300 absolute bottom-3 ${active ? 'opacity-100 translate-y-0 text-slate-800 dark:text-slate-200' : 'opacity-0 translate-y-2'}`}>{label}</span>
            </button>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<AttendanceApp />);
    </script>
</body>
</html>
